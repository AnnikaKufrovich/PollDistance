---
title: "Polling Location Webscraper"
author: "Annika Kufrovich"
date: "July 14, 2020"
output: html_document
---


###Intro

This document will go through how to webscrape for a single Florida county's currently polling locations for each precinct from voterfocus.com. In this case we will be using Alachua. After that we'll scrape polling locations for all Florida counties (with the exception of Orange and Sarasota counties). For a basic guide on how to webscrape see this link: [https://www.analyticsvidhya.com/blog/2017/03/beginners-guide-on-web-scraping-in-r-using-rvest-with-hands-on-knowledge/]



##Alachua

Loading packages
```{r, message=FALSE, warning=FALSE}
library(rvest)
library(dplyr)
library(stringr)
```


reading in url
```{r}
url <- 'https://www.voterfocus.com/PrecinctFinder/precinctDirectory?county=FL-ALA' ##you could also use "", doesn't really matter
webpage <- read_html(url)
```


Getting Precinct numbers. 
```{r}
#Using CSS selectors to scrape the precinct number section
number_data_html <- html_nodes(webpage,'.PageSection .Title')

#Converting the data to text
number_data <- html_text(number_data_html)

#Inspecting data
head(number_data)

##Removing precinct string from all entries
prec_numbers <- str_remove_all(number_data, "Precinct ")

```


Getting addresses
```{r}
#Using CSS selectors to scrape the address section
address_data_html <- html_nodes(webpage,'.NameAndAddress a')

#Converting the data to text
address_data <- html_text(address_data_html)

#Inspecting data
head(address_data)

##replacing \r\n\r\n\t\t\t\t\t\t\t\t\t with ", "
poll_address <- str_replace_all(address_data, "\r\n\t\t\t\t\t\t\t\t\t", ", ")
```


Getting location names (in case they are needed for crosschecking addresses later)

```{r}
#Using CSS selectors to scrape the address section
name_data_html <- html_nodes(webpage,'.Name')

#Converting the data to text
name_data <- html_text(name_data_html)

#Inspecting data
head(name_data)

##removing \r\n\r\n\t\t\t\t\t\t\t\t\t and \r\n\t\t\t\t\t\t\t\t
poll_name <- str_remove_all(name_data, "\r\n\t\t\t\t\t\t\t\t\t")
poll_names <- str_remove_all(poll_name, "\r\n\t\t\t\t\t\t\t\t")
head(poll_names)
```

Making a data frame

```{r}
ALApollplace <- data.frame(precinct = prec_numbers, address = poll_address, pollname = poll_names)
head(ALApollplace)
```




##Every Florida County

Making a vector of all the 3 letter endings for the voterfocus link. Leaving out Orange County and Sarasota County since they have no precinct polling locations displayed on this website. You can find official county abbreviations here: [https://floridaqsoparty.org/counties/counties-list/], however the voterfocus website mainly uses the first 3 letters or different abbreviations of the county name. (Will check later what abbreviations voter file has.)

```{r}
endings <- c("ALA", "BAK", "BAY", "BRA", "BRE", "BRO", "CAL", "CHA", "CIT", "CLA", "CLL", "CLM", "DAD", "DES", "DIX", "DUV", "ESC", "FLA", "FRA", "GAD", "GIL", "GLA", "GUL", "HAM", "HAR", "HEN", "HER", "HIG", "HIL", "HOL", "IND", "JAC", "JEF", "LAF", "LAK", "LEE", "LEV", "LIB", "MAD", "MAN", "MRN", "MRT", "MON", "NAS", "OKA", "OKE", "OSC", "PAL", "PAS", "PIN", "POL", "PUT", "SAN", "SEM", "STJ", "STL", "SUM", "SUW", "TAY", "UNI", "VOL", "WAK", "WAL", "WAS")

leo_ending <- c("LEO") ##Doing separately since one of the precincts at the time of coding has no polling location information in such a way that it could mess up the webscraper (eg it won't scrape NA or an empty line for precinct 1201)

no_info_endings <- c("ORA", "SAR") ##Orange and Sarasota County's pages were empty as of 7/17/20

```

```{r}
incomplete_url <- "https://www.voterfocus.com/PrecinctFinder/precinctDirectory?county=FL-"

##setting up empty vectors to be added to in for loop
countyabr <- c()
prec_nums <- c()
addresses <- c()

for(i in 1:length(endings)){
  webpage <- read_html(paste0(incomplete_url, endings[i])) ##reading county-specific webpage
  number.data.html <- html_nodes(webpage,'.PageSection .Title') ##scraping precint numbers
  number.data <- html_text(number.data.html) ##converting to text
  prec.numbers <- str_remove_all(number.data, "Precinct ") #removing unnecesary part of string
  length <- length(prec.numbers) #needed to add county abbreviation for each precinct entry
  countyabr <- c(countyabr, rep(endings[i], length)) #Adding county abreviation for each entry, can be changed later to appropriate abbreviations for voter file
  prec_nums <- c(prec_nums, prec.numbers) #Adding precinct numbers
  address.data.html <- html_nodes(webpage,'.NameAndAddress a') #scraping addresses
  address.data <- html_text(address.data.html) ##converting to text
  poll.address <- str_replace_all(address.data, "\r\n\t\t\t\t\t\t\t\t\t", ", ") #replacing unnecesary part of string
  addresses <- c(addresses, poll.address) #adding to addresses vector
  
}




```